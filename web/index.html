<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
</head>
<body>
<h2>OpenCV.jsのテスト</h2>
<p id="status">OpenCV.js is loading...</p>
<div>
  <div class="inputoutput">
    <video id="video" muted width="320" height="240"></video>
    <div class="caption">imageSrc <input type="file" id="fileInput" name="file" /></div>
  </div>
  <div class="inputoutput">
    <canvas id="canvasOutput" ></canvas>
    <div class="caption">canvasOutput</div>
  </div>
</div>

<div id="webmidi">
    <h2>WebMIDI APIのテスト</h2>
    <p>{{ midiOutputIsReady ? "ボタンを押すと「ドレミファソラシド」が鳴ります" : "MIDIデバイスがありません" }}</p>
    <button @click="playScale()">鳴らす</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script>
    let video = document.getElementById('video');
    let inputElement = document.getElementById('fileInput');
    inputElement.addEventListener('change', (e) => {
        video.src = URL.createObjectURL(e.target.files[0]);
        countFrames();
    }, false);
    function onOpenCvReady() {
        document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
    }

    function countFrames() {
        let width = video.width;
        let height = video.height;
        let src = new cv.Mat(height, width, cv.CV_8UC4);
        let dst = new cv.Mat(height, width, cv.CV_8UC1);
        
        let loop = setInterval(() => {
            try {
                if(video.duration <= video.currentTime + 0.1){
                    console.log("end");
                    clearInterval(loop);
                    src.delete();
                    dst.delete();
                    return
                }
                video.currentTime += 0.1;
                let cap = new cv.VideoCapture(video);
                cap.read(src);
                cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
                cv.imshow('canvasOutput', dst);
            } catch(e){
                console.log("error")
                console.log(e);
                clearInterval(loop);
                src.delete();
                dst.delete();
            }
        }, 100)
    }

    //WebMidiの実験

    new Vue({
        el: '#webmidi',
        data: {
            midiOutputIsReady: false,
            outputDevice: null,
            count: 0
        },
        computed: {

        },
        methods: {
            playScale() {
                console.log("playScale");
                let o = this.outputDevice;
                let scale = [60, 62, 64, 65, 67, 69, 71, 72];
                for(let i = 0; i < 8; i++){
                    o.send([0x90, scale[i], 100], window.performance.now() + 200+1000*i);
                    o.send([0x80, scale[i], 0], window.performance.now() + 200+1000*(i+1));
                }
            }
        },
        mounted(){
            navigator.requestMIDIAccess().then((midiAccess)=>{ //成功
                console.log("MIDI ready!");
                // デバイスが 1台だけつながっている前提 ないとエラーになる
                // const input = midiAccess.inputs.values().next();
                // console.log(input.value.manufacturer);
                // console.log(input.value.name);
                // input.value.onmidimessage = onMIDIMessage;
                try {
                    let output = midiAccess.outputs.values().next();
                    this.outputDevice = output.value;
                    console.log(this.outputDevice.name);
                    this.midiOutputIsReady = true;
                } catch(e) {
                    console.log("cannot find MIDI device");
                }
            }, (msg)=>{ //失敗
                console.log("Failed to get MIDI access - " + msg);
            });
        }
    })
    

    function onMIDIMessage(message) {
        const data = message.data;
        console.log("MIDI data: ", data);
    }

    
</script>
<script async src="opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
</body>
</html>